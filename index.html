document.addEventListener('DOMContentLoaded', () => {
  // ===== "–ß–ê–†–Ü–í–ù–ò–ô" –†–Ø–î–û–ö –î–õ–Ø SAFARI =====
  document.body.addEventListener('touchstart', () => {}, {passive: true});

  // ===== DOM –µ–ª–µ–º–µ–Ω—Ç–∏ =====
  const screens = document.querySelectorAll('.screen');
  const workoutModal = document.getElementById('workoutModal');
  const modalProgramNameEl = document.getElementById('modalProgramName');
  const modalExerciseListEl = document.getElementById('modalExerciseList');
  const modalStartBtn = document.getElementById('modalStartBtn');
  const modalSettingsBtn = document.getElementById('modalSettingsBtn');
  const closeModalBtn = workoutModal.querySelector('.close-button');
  const workoutTiles = document.querySelectorAll('.neumorphic-tile[data-program]');
  const burgerBtn = document.getElementById('burgerBtn');
  const sideMenu = document.getElementById('sideMenu');
  const restDayBtn = document.getElementById('restDayBtn');
  const datetimeDisplayEl = document.getElementById('datetime-display');
  const trainingScreen = document.getElementById('trainingScreen');
  const trainingBackBtn = document.getElementById('trainingBackBtn');
  const trainingProgramNameEl = document.getElementById('trainingProgramName');
  const exerciseNameEl = document.getElementById('exerciseName');
  const timerEl = document.getElementById('timer');
  const prevBtn = document.getElementById('prevExercise');
  const pauseBtn = document.getElementById('pauseBtn');
  const stopBtn = document.getElementById('stopBtn');
  const nextBtn = document.getElementById('nextExercise');
  const completedListEl = document.getElementById('completedExercises');
  const countdownScreen = document.getElementById('countdownScreen');
  const countdownNumberEl = document.getElementById('countdownNumber');
  // --- Menu elements ---
  const menuBackBtn = document.getElementById('menuBackBtn');
  const menuTitle = document.getElementById('menuTitle');
  const mainMenu = document.getElementById('mainMenu');
  const workoutSettingsMenu = document.getElementById('workoutSettingsMenu');
  const statsSettingsMenu = document.getElementById('statsSettingsMenu');
  const goalSettingsMenu = document.getElementById('goalSettingsMenu');
  const appSettingsMenu = document.getElementById('appSettingsMenu');
  const calendarMenu = document.getElementById('calendarMenu');
  const historyMenu = document.getElementById('historyMenu');
  const bgUrlInput = document.getElementById('bgUrlInput');
  const saveBgBtn = document.getElementById('saveBgBtn');
  const resetBgBtn = document.getElementById('resetBgBtn');
  const homeScreen = document.getElementById('homeScreen');
  // --- Workout Settings Elements ---
  const programListEl = document.getElementById('program-list');
  const addNewProgramBtn = document.getElementById('addNewProgramBtn');
  const addProgramMenu = document.getElementById('addProgramMenu');
  const newProgramNameInput = document.getElementById('newProgramNameInput');
  const saveNewProgramBtn = document.getElementById('saveNewProgramBtn');
  const programEditMenu = document.getElementById('programEditMenu');
  const programNameInput = document.getElementById('programNameInput');
  const exerciseListEl = document.getElementById('exercise-list');
  const addExerciseBtn = document.getElementById('addExerciseBtn');
  const saveProgramBtn = document.getElementById('saveProgramBtn');
  const deleteProgramBtn = document.getElementById('deleteProgramBtn');
  // --- Exercise Modal Elements ---
  const exerciseModal = document.getElementById('exerciseModal');
  const exerciseModalTitle = document.getElementById('exerciseModalTitle');
  const exerciseNameInput = document.getElementById('exerciseNameInput');
  const exerciseDurationInput = document.getElementById('exerciseDurationInput');
  const saveExerciseBtn = document.getElementById('saveExerciseBtn');
  const closeExerciseModalBtn = exerciseModal.querySelector('.close-button');
  // --- Finish Modal Elements ---
  const finishModal = document.getElementById('finishModal');
  const caloriesInput = document.getElementById('caloriesInput');
  const difficultySlider = document.getElementById('difficultySlider');
  const sliderEmojiBubble = document.getElementById('sliderEmojiBubble');
  const energyRating = document.getElementById('energyRating');
  const starRating = document.getElementById('starRating');
  const saveWorkoutLogBtn = document.getElementById('saveWorkoutLogBtn');

  // ===== –ù–∞–≤—ñ–≥–∞—Ü—ñ—è =====
  function showScreen(screenId) { /* ... —Ç—ñ–ª–æ —Ñ—É–Ω–∫—Ü—ñ—ó –±–µ–∑ –∑–º—ñ–Ω ... */ }
  // ===== –î–∞—Ç–∞ —ñ —á–∞—Å =====
  if (datetimeDisplayEl) { /* ... —Ç—ñ–ª–æ —Ñ—É–Ω–∫—Ü—ñ—ó –±–µ–∑ –∑–º—ñ–Ω ... */ }
  // ===== –õ–æ–≥—ñ–∫–∞ —Ç—Ä–µ–Ω—É–≤–∞–Ω—å (–æ—Å–Ω–æ–≤–Ω–∞) =====
  const poolHIIT = ['–ë–µ—Ä–ø—ñ', '–î–∂–∞–º–ø-—Å–∫–≤–æ—Ç', '–°–ø—Ä–∏–Ω—Ç –Ω–∞ –º—ñ—Å—Ü—ñ', '–ê–ª—å–ø—ñ–Ω—ñ—Å—Ç', '–ü–ª–∞–Ω–∫–∞', '–°—Ç—Ä–∏–±–∫–∏ –¥–∂–µ–∫'];
  const poolMIX = ['–ü—Ä–∏—Å—ñ–¥–∞–Ω–Ω—è –∑ –≥–∞–Ω—Ç–µ–ª—è–º–∏','–¢—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–µ–π —É –Ω–∞—Ö–∏–ª—ñ','–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª–µ–∂–∞—á–∏'];
  const poolCommon = ['–í—ñ–¥–∂–∏–º–∞–Ω–Ω—è','–ü–ª–∞–Ω–∫–∞','–°—Ç—Ä–∏–±–∫–∏ –Ω–∞ –º—ñ—Å—Ü—ñ','–í–∏–ø–∞–¥–∏','–°–∫—Ä—É—á—É–≤–∞–Ω–Ω—è'];
  function shuffle(arr) { return [...arr].sort(() => Math.random() - 0.5); }
  function buildWorkout(programName) { /* ... —Ç—ñ–ª–æ —Ñ—É–Ω–∫—Ü—ñ—ó –±–µ–∑ –∑–º—ñ–Ω ... */ }

  let currentProgram = '', exercises = [], currentIndex = 0, remainingTime = 0, timerInterval = null, isPaused = true, isStarted = false;
  
  function formatTime(seconds) { /* ... —Ç—ñ–ª–æ —Ñ—É–Ω–∫—Ü—ñ—ó –±–µ–∑ –∑–º—ñ–Ω ... */ }
  function updateUI() { /* ... —Ç—ñ–ª–æ —Ñ—É–Ω–∫—Ü—ñ—ó –±–µ–∑ –∑–º—ñ–Ω ... */ }
  function tick() { /* ... —Ç—ñ–ª–æ —Ñ—É–Ω–∫—Ü—ñ—ó –±–µ–∑ –∑–º—ñ–Ω ... */ }
  function startTimer() { /* ... —Ç—ñ–ª–æ —Ñ—É–Ω–∫—Ü—ñ—ó –±–µ–∑ –∑–º—ñ–Ω ... */ }
  
  function finishWorkout() {
    clearInterval(timerInterval);
    isStarted = false;
    isPaused = true;
    
    if (finishModal) {
      // –°–∫–∏–¥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –≤—ñ–∫–Ω–∞ –¥–æ –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ
      caloriesInput.value = '';
      difficultySlider.value = 3;
      updateSliderEmoji(); // –û–Ω–æ–≤–ª—é—î–º–æ –µ–º–æ–¥–∑—ñ
      starRating.querySelectorAll('span').forEach(s => s.classList.remove('active'));
      energyRating.querySelectorAll('span').forEach(e => e.classList.remove('active'));
      energyRating.querySelector('[data-value="5"]').classList.add('active'); // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –¥–µ—Ñ–æ–ª—Ç–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è

      finishModal.classList.add('active');
    } else {
      alert('–¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ! üí™');
      showScreen('homeScreen');
    }
  }

  function confirmExitTraining() { /* ... —Ç—ñ–ª–æ —Ñ—É–Ω–∫—Ü—ñ—ó –±–µ–∑ –∑–º—ñ–Ω ... */ }
  function startWorkout(programName) { /* ... —Ç—ñ–ª–æ —Ñ—É–Ω–∫—Ü—ñ—ó –±–µ–∑ –∑–º—ñ–Ω ... */ }
  function _actuallyStartWorkout(programName) { /* ... —Ç—ñ–ª–æ —Ñ—É–Ω–∫—Ü—ñ—ó –±–µ–∑ –∑–º—ñ–Ω ... */ }

  // ===== –û–±—Ä–æ–±–Ω–∏–∫–∏ –ü–æ–¥—ñ–π =====
  if (pauseBtn) { /* ... */ }
  if (stopBtn) { /* ... */ }
  if (trainingBackBtn) { /* ... */ }
  if (nextBtn) { /* ... */ }
  if (prevBtn) { /* ... */ }

  // ===== –õ–æ–≥—ñ–∫–∞ –ú–æ–¥–∞–ª—å–Ω–æ–≥–æ –í—ñ–∫–Ω–∞ =====
  function openWorkoutModal(programName) { /* ... */ }
  workoutTiles.forEach(tile => { /* ... */ });
  if(closeModalBtn) { /* ... */ }
  if(workoutModal) { /* ... */ }
  if(modalSettingsBtn) { /* ... */ }
  
  // ===== –õ–û–ì–Ü–ö–ê –ù–ê–õ–ê–®–¢–£–í–ê–ù–¨ –î–û–î–ê–¢–ö–£ (–§–û–ù) =====
  function applyBackground(url) { /* ... */ }
  if (saveBgBtn) { /* ... */ }
  if (resetBgBtn) { /* ... */ }
  
  // ===== –õ–û–ì–Ü–ö–ê –ù–ê–õ–ê–®–¢–£–í–ê–ù–¨ –¢–†–ï–ù–£–í–ê–ù–¨ =====
  let workoutPrograms = {}; 
  let currentlyEditing = null; 
  function loadPrograms() { /* ... */ }
  function savePrograms() { /* ... */ }
  function renderProgramList() { /* ... */ }
  function renderExerciseList(programName) { /* ... */ }
  function openProgramEditor(programName) { /* ... */ }
  if (addNewProgramBtn) { /* ... */ }
  if (saveNewProgramBtn) { /* ... */ }
  if (saveProgramBtn) { /* ... */ }
  if (deleteProgramBtn) { /* ... */ }
  if (addExerciseBtn) { /* ... */ }
  if (saveExerciseBtn) { /* ... */ }
  if (closeExerciseModalBtn) { /* ... */ }

  // ===== –õ–û–ì–Ü–ö–ê –ú–û–î–ê–õ–ö–ò –ü–Ü–°–õ–Ø –¢–†–ï–ù–£–í–ê–ù–ù–Ø =====
  const difficultyEmojis = ['üòå', 'üôÇ', 'üòÆ‚Äçüí®', 'üòµ', 'ü•µ', 'üíÄ'];
  
  function updateSliderEmoji() {
    if (!difficultySlider || !sliderEmojiBubble) return;
    const value = difficultySlider.value;
    const min = difficultySlider.min;
    const max = difficultySlider.max;
    const percent = (value - min) / (max - min);
    const thumbWidth = 26; // –®–∏—Ä–∏–Ω–∞ –ø–æ–≤–∑—É–Ω–∫–∞
    const trackWidth = difficultySlider.offsetWidth;
    const offset = (thumbWidth / 2) - (trackWidth * percent);
    
    sliderEmojiBubble.style.left = `calc(${percent * 100}% - ${offset}px)`;
    sliderEmojiBubble.textContent = difficultyEmojis[value - 1];
  }

  if (difficultySlider) {
    difficultySlider.addEventListener('input', updateSliderEmoji);
  }

  function setupEmojiRating(container) {
    if (!container) return;
    const emojis = container.querySelectorAll('span');
    emojis.forEach(emoji => {
      emoji.addEventListener('click', () => {
        emojis.forEach(e => e.classList.remove('active'));
        emoji.classList.add('active');
      });
    });
  }

  setupEmojiRating(energyRating);

  if (starRating) {
    const stars = starRating.querySelectorAll('span');
    stars.forEach(star => {
      star.addEventListener('click', () => {
        const currentRating = star.dataset.value;
        stars.forEach(s => {
          s.classList.toggle('active', s.dataset.value <= currentRating);
        });
      });
    });
  }

  if (saveWorkoutLogBtn) {
    saveWorkoutLogBtn.addEventListener('click', () => {
      const calories = parseInt(caloriesInput.value, 10) || 0;
      const difficulty = parseInt(difficultySlider.value, 10);
      const activeEnergyEl = energyRating.querySelector('span.active');
      const energy = activeEnergyEl ? parseInt(activeEnergyEl.dataset.value, 10) : 5;
      const rating = starRating.querySelectorAll('span.active').length;
      
      const workoutLog = {
        date: new Date().toISOString(), program: currentProgram,
        calories, difficulty, energy, rating,
        exercises: exercises.slice(0, -1)
      };
      
      const history = JSON.parse(localStorage.getItem('workoutHistory')) || [];
      history.push(workoutLog);
      localStorage.setItem('workoutHistory', JSON.stringify(history));
      alert('–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ! –ö—Ä–∞—Å—É–Ω—á–∏–∫!');
      
      finishModal.classList.remove('active');
      showScreen('homeScreen');
    });
  }
  
  // ===== –õ–û–ì–Ü–ö–ê –ë–û–ö–û–í–û–ì–û –ú–ï–ù–Æ =====
  if (burgerBtn && sideMenu && mainMenu && menuBackBtn && menuTitle) { /* ... */ }
  
  // ===== –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è =====
  loadPrograms(); 
  renderProgramList();
  const savedBg = localStorage.getItem('customBackground');
  if (savedBg) { /* ... */ }
  updateSliderEmoji(); // –í–∏–∫–ª–∏–∫–∞—î–º–æ, —â–æ–± –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –µ–º–æ–¥–∑—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
  showScreen('homeScreen');
});
